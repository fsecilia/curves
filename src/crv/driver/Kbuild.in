# SPDX-License-Identifier: GPL-2.0+ OR MIT
# Copyright (c) 2026 Frank Secilia

obj-m += @kbuild_output@

# find relative c++ compiler
ifeq ($(CXX),)
    CXX := $(patsubst %cc,%g++,$(patsubst %gcc,%g++,$(patsubst %clang,%clang++,$(CC))))
endif

# filter c flags for conflicts with c++
filtered_c_flags := -std=gnu% \
                    -Wdesignated-init \
                    -Werror=designated-init \
                    -Werror=implicit-function-declaration \
                    -Werror=implicit-int \
                    -Werror=incompatible-pointer-types \
                    -Werror=strict-prototypes \
                    -Wimplicit- \
                    -Wimplicit-function-declaration \
                    -Wimplicit-int \
                    -Wincompatible-pointer-types \
                    -Wmissing-prototypes \
                    -Wno-override-init \
                    -Wno-pointer-sign \
                    -Wno-unterminated-string-initialization \
                    -Wno-unused-const-variable \
                    -Wstrict-prototypes
common_flags = $(filter-out $(filtered_c_flags), $(KBUILD_CFLAGS))

# combine c++ flags
cxx_flags = $(common_flags) @kbuild_c_flags@ @kbuild_cxx_flags@

# add standard c++ compile rule
quiet_cmd_cxx_o_cpp = CXX [M]  $@
cmd_cxx_o_cpp = $(CXX) $(cxx_flags) -c -o $@ $<

# add standard c++ pattern rule
$(obj)/%.o: $(src)/%.cpp FORCE
	$(call if_changed,cxx_o_cpp)

# configure floating point sources
srcs_float := @srcs_kbuild_float@
$(foreach obj,$(srcs_float),$(eval CFLAGS_REMOVE_$(obj) += $(CC_FLAGS_NO_FPU)))
$(foreach obj,$(srcs_float),$(eval CFLAGS_$(obj)        += $(CC_FLAGS_FPU)))

@driver_name@-y := @srcs_kbuild@ $(srcs_float)

ccflags-y += -I$(src) -DCRV_DRIVER_VERSION="@PROJECT_VERSION@-@git_hash@"
