// SPDX-License-Identifier: GPL-2.0+ OR MIT
/*
 * The math in this module is primarily based on minimax approximations, which
 * are polynomial functions that minimize the error of an approximation over a
 * specific range. Calculating approximations with them is reasonably
 * efficient, but determining their coefficients is nontrivial; the process
 * runs Chubuchev polynomials through a truncation-aware Remez exchange
 * algorithm. To manage this, they were generated by a open source, academic
 * tool called Sollya. The scripts used to generate the coefficients are listed
 * next to the coefficients themselves.
 *
 * Copyright (C) 2025 Frank Secilia
 * Author: Frank Secilia <frank.secilia@gmail.com>
 */

#include "fixed.h"

extern curves_fixed_t curves_const_1(unsigned int frac_bits);
extern curves_fixed_t curves_const_e(unsigned int frac_bits);
extern curves_fixed_t curves_const_ln2(unsigned int frac_bits);
extern curves_fixed_t curves_const_pi(unsigned int frac_bits);

extern curves_fixed_t curves_fixed_from_integer(unsigned int frac_bits,
						int64_t value);
extern int64_t curves_fixed_to_integer(unsigned int frac_bits,
				       curves_fixed_t value);

extern curves_fixed_t curves_fixed_multiply(unsigned int multiplicand_frac_bits,
					    curves_fixed_t multiplicand,
					    unsigned int multiplier_frac_bits,
					    curves_fixed_t multiplier,
					    unsigned int output_frac_bits);

extern curves_fixed_t __curves_fixed_saturate(bool result_positive);

extern curves_fixed_t
__curves_fixed_divide_try_saturate(curves_fixed_t dividend,
				   curves_fixed_t divisor, int128_t threshold);

extern curves_fixed_t curves_fixed_divide(unsigned int dividend_frac_bits,
					  curves_fixed_t dividend,
					  unsigned int divisor_frac_bits,
					  curves_fixed_t divisor,
					  unsigned int output_frac_bits);

extern curves_fixed_t
__curves_fixed_divide_try_saturate_lshift(curves_fixed_t dividend,
					  curves_fixed_t divisor,
					  int saturation_threshold_bit);

extern curves_fixed_t
__curves_fixed_divide_try_saturate_rshift(curves_fixed_t dividend,
					  curves_fixed_t divisor,
					  int saturation_threshold_bit);

curves_fixed_t __cold __curves_fixed_multiply_error(curves_fixed_t multiplicand,
						    curves_fixed_t multiplier,
						    int shift)
{
	// Right shift tends towards 0 in the limit, so return 0.
	if (shift < 0)
		return 0;

	// 0 stays 0.
	if (multiplicand == 0 || multiplier == 0)
		return 0;

	// This is a large left shift. Saturate based on sign of product.
	return (multiplicand > 0) == (multiplier > 0) ? INT64_MAX : INT64_MIN;
}

curves_fixed_t __cold __curves_fixed_divide_error(curves_fixed_t dividend,
						  curves_fixed_t divisor,
						  int shift)
{
	// 0 if dividend is 0 or we're shifting right without a singularity.
	if (dividend == 0 || (divisor != 0 && shift < 0))
		return 0;

	// Otherwise, saturate based on sign of quotient.
	return __curves_fixed_saturate((dividend ^ divisor) >= 0);
}
